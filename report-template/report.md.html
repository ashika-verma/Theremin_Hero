<meta charset="utf-8" emacsmode="-*- markdown -*-">

System Overviw
===============================================================================

Block Diagram
===============================================================================
![Figure [block-diagram]: some text text](./images/block-diagram.png width="500px" border="1")

State Machine
===============================================================================


Challenges
===============================================================================

**Server-Side Audio Generation**

* We formatted music strings as pairs of frequency and interval length values. We used python’s *numpy* and *soundfile* libraries to generate sine waves and concatenate them into a single .OGG sound file. 
* However, the dicontinuities in the concatenated sine wave produced clikcing sounds whenever the tone changed in any music file.
* Therefore, we saved the last amplitude value in each sine wave subinterval representing a single frequency, from which we calculated the amplitude value at which the next different-frequency sine wave would start.

**Distance Sensing**

* Ultrasonic Sensor
  * The original design of the Theremin Hero relied on pulsing ultrasonic sensors to provide information on the  distance of the player’s hands.
  * However, these sensors were prone to noise, required perfectly flat surfaces, and were quite unreliable even with the help of averaging filters and other software fixes.
* Infrared Sensor
  * Similar to the ultrasonic sensors, the IR sensor did not produce very consistent results and did not work very well with rough surfaces
* TOF (Time of Flight) Sensor
  * The TOF sensor was ultimately the best fit for this project. Although it does not have as large a range as the other sensors, accuracy was the greatest concern for this project, not range.
  * The pulsating light beam works well with complex surfaces like a hand and can even detect figures such as fingers reasonably well.
  * Unlike with ultrasound, the environment does not have much noise that would interfere with the TOF sensor. Additionally, the light pulses are well isolated in a region in front of the sensor and are roughly the size of a hand (viewed through UV/IR laser

**Volume Control**

* Ultrasonic Sensor
  * Although the original plan was for an additional ultrasonic sensor to measure distance for the volume, the interference of one ultrasonic sensor rendered readings inaccurate, let alone another polluting the environment with ultrasonic propagations.
* TOF Sensor
  * A secondary TOF sensor was another option for the volume control but since they would share the same I2C bus and, being the same part, have the same address it would likely cause problems
* Digital Inputs
  * Initially believing it would be possible to control the volume with PWM/Duty cycles it became clear that would not yield appropriate results.
  * Considered using a digi-pot to change the voltage entering the buzzer but would be limited to discrete values.
* Analog Potentiometer
  * A sliding potentiometer became the volume control for the final iteration of the project. Trouble with digitally controlling the volume suggested an analog fix would be ideal and allow for more continuous volume adjustments.
  * Originally using a screw-top potentiometer, many different resistors were attempted including photocells and flex sensors but a sliding potentiometer became the most reliable and functional solution.

**Visualization**

* Screen visualization
  * When implementing the “game” portion of the project, a difficult design choice was determining how to transmit to the player what notes to play in an intuitive way.
  * Like many other beat/rhythm games it became obvious the best structure was some sort of moving or falling note system.
  * After some thought, it seemed integral that the player have a visual reminiscent of the instrument’s fretboard. This allows the player, while in a competitive mode, to be able to focus on the screen and the prompted notes rather than the fretboard.
* Fretboard/LEDs
  * Besides the screen a physical representation for the player seemed ideal which intuitively came in the form of a fretboard.
  * For the player to get a better idea of their positioning, LEDs were added and programmed not only light up the current note but also to act as a guide for what notes to play in competitive mode.

**Audio Generation**

* Piezo Buzzer
  * Figuring out how to emit audio of reasonable quality was difficult for much of the design process.
  * A simple piezo buzzer sounded subpar with square waves and would have many issues with audio cut outs, overtones, and popping. However, the buzzer was useful for initial testing of the system.
* Amplifier/Speaker
  * The final audio setup consists of an amplifier chip and speaker which greatly improved audio quality and made volume control much more reasonable.
* Software
  * After playing with the idea of MIDI files or using an SD card and MP3s it seemed the best to just go with arduinos built in tone producing functions using PWM at an analog input. This allowed us to easily produce and change the tones without any other files.
  * Choosing when to write and update tones was crucial to removing periodic buzzing and audio cut-outs so ensuring not to rewrite notes every time interval helped smooth out sound
  * The PWM used for screen brightness seemed to receive some interference from the PWM for audio output. A simple and unexpected fix was to create greater distance between PWM channels. (Initially using 0,1 and moving to use 0,14).

**User Inputs**

* IMU
  * A small but crucial design decision was implementing the IMU for scrolling movement through the alphabet for song names and usernames.
  * A significant improvement from button scrolling.

**Note Mapping**

* Linear Scaling change
* Found the mapping function

Parts List
===============================================================================

* **Time of Flight sensor**
  * VL6180X Time-of-Flight Distance Sensor Carrier with Voltage Regulator
* **Slider Potentiometer** 
  * Robotdyn Analog Slide Potentiometer 10K ohm
* **Arduino Stereo Audio Amplifier**
  * PAM8403 5V Two-channel Stereo Mini Class-D 3W+3W Audio Amplifier
* **Speaker**
  * 1.5" 4Ohm 3W Full Range Audio Speaker Stereo Woofer Loudspeaker
* ~1ft of side emitting RBG LEDs
* 1/4th Inch Black and Clear Acrylic
* Additional small breadboard

Code Documetation
===============================================================================

Energy management
===============================================================================

<!-- Markdeep: --><style class="fallback">body{visibility:hidden;white-space:pre;font-family:monospace}</style><script src="markdeep.min.js" charset="utf-8"></script><script src="https://casual-effects.com/markdeep/latest/markdeep.min.js?" charset="utf-8"></script><script>window.alreadyProcessedMarkdeep||(document.body.style.visibility="visible")</script>